#!/usr/bin/env python
"""
 write_mock_samples
 
 author: Nick Hand
 contact: nhand@berkeley.edu
 creation date: 12/20/2014
"""
from lss import load_catalog
import argparse
import os
from glob import glob

#-------------------------------------------------------------------------------
def main(args):
    """
    Write out a formatted coordinates of the mock
    """
    # the restrictions
    centrals = "(type == central)"
    satellites = "(type == satellite)"
    cen_halo_restricts = {'A' : "(N_sat == 0)", 'B' : "(N_sat > 0)"}
    sat_halo_restricts = {'A' : "(N_sat == 1)", 'B' : "(N_sat > 1)"}
    
    # output columns
    fields = ['x', 'y', 'z_real', 'z_redshift']
    
    files = glob(args.pattern)
    for f in files:
        print "processing %s..." %f
        
        # load
        mock = load_catalog(f)
        
        # file manipulation
        abspath = os.path.abspath(f)
        directory, filename = os.path.split(abspath)
        basename, ext = os.path.splitext(filename)
     
        # clear any restrictions
        mock.clear_restrictions()
    
        # galaxy restrictions
        if args.sample == 'halo':            
            conds = []
            if args.min_logmass is not None:
                conds.append("(mass >= %s)" %(10**args.min_logmass))
            if args.max_logmass is not None:
                conds.append("(mass < %s)" %(10**args.max_logmass))
            
            if len(conds) == 2:
                mock.restrict_halos(" and ".join(conds))
            else:
                mock.restrict_halos(conds[0])
            if hasattr(mock.sample, 'type'):
                mock.restrict_galaxies(centrals)
        elif 'cen' in args.sample:
            mock.restrict_galaxies(centrals)
        elif 'sat' in args.sample:
            mock.restrict_galaxies(satellites)

        # halo restrictions
        if args.sample == 'cenA':
            mock.restrict_halos(cen_halo_restricts['A'])
        elif args.sample == 'cenB':
            mock.restrict_halos(cen_halo_restricts['B'])
        elif args.sample == 'satA':
            mock.restrict_halos(sat_halo_restricts['A'])
        elif args.sample == 'satB': 
            mock.restrict_halos(sat_halo_restricts['B'])

        # write out the mock coordinates
        tag = args.sample
        if tag == 'halo':
            if len(conds) == 2:
                tag += "_%.2f_to_%.2f" %(args.min_logmass, args.max_logmass)
            else:
                if args.min_logmass is not None:
                    tag += "_gt_%.2f" %(args.min_logmass)
                else:
                    tag += "_lt_%.2f" %(args.max_logmass)
                    
        output_file = "%s/%s_%s.dat" %(args.output_dir, basename, tag)
        mock.write_coordinates(output_file, fields, units=args.output_units, 
                                header=None, temporary=False, replace_with_nearest=False)
    
#end main
    
#-------------------------------------------------------------------------------
if __name__ == '__main__':
    
    # parse the input arguments
    desc = "write out the specific mock samples"
    parser = argparse.ArgumentParser(description=desc, 
                            formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    
    h = "the pattern to match mock files on"
    parser.add_argument('pattern', type=str, help=h) 

    h = 'the galaxy sample'
    choices = ['all', 'cen', 'cenA', 'cenB', 'sat', 'satA', 'satB', 'halo']
    parser.add_argument('sample', default='all', choices=choices, help=h)
    
    h = 'output directory to write results to'
    parser.add_argument('--output_dir', type=str, default='.', help=h)
    
    h = 'output units'
    parser.add_argument('--output_units', type=str, choices=['relative', 'absolute'], default='relative', help=h)
    
    h = 'log10 of the lower halo mass (inclusive) limit in M_sun/h'
    parser.add_argument('--min_logmass', type=float, help=h)
    
    h = 'log10 of the upper halo mass (exclusive) limit in M_sun/h'
    parser.add_argument('--max_logmass', type=float, help=h)
    
    args = parser.parse_args()
    main(args)
    
#-------------------------------------------------------------------------------